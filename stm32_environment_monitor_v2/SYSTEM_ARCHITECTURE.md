# STM32F103环境监测系统架构设计文档 V2.0

**作者**: MiniMax Agent  
**日期**: 2025-11-08  
**版本**: V2.0

## 1. 总体架构概述

### 1.1 系统目标
- 基于STM32F103C8T6微控制器的环境监测系统
- 使用STM32标准外设库（非HAL库）
- FreeRTOS实时操作系统支持
- 4任务并发架构
- 数据存储：内部Flash（WiFi配置）+ SPI Flash（传感器数据）
- 通信：蓝牙(USART2) + WiFi(USART3) + 调试(USART1)
- 数据格式：简单文本格式"传感器名:数据\r\n"

### 1.2 关键技术要求
**✅ 已确认要求:**
- 使用STM32标准外设库（非HAL库）
- 完全去除时间戳功能
- 使用简单数据格式（无HTTP）
- 无数据统计功能
- 详细注释和知识点补充
- 完整的头文件和源文件分离

**❌ 禁止功能:**
- HAL库函数（HAL_Init, HAL_GetTick等）
- 任何时间戳相关代码
- HTTP数据封装
- 数据统计分析
- MX_*系列HAL函数

## 2. 硬件架构设计

### 2.1 核心处理器
- **芯片**: STM32F103C8T6
- **架构**: ARM Cortex-M3, 32位RISC
- **主频**: 72MHz
- **Flash**: 64KB
- **SRAM**: 20KB
- **封装**: LQFP48

### 2.2 外设资源分配

#### 2.2.1 串口通信
| 串口 | 用途 | 波特率 | TX引脚 | RX引脚 | 功能 |
|------|------|--------|--------|--------|------|
| USART1 | 调试通信 | 9600 | PA9 | PA10 | PC调试，printf输出 |
| USART2 | HC-05蓝牙 | 9600 | PA2 | PA3 | 蓝牙数据传输 |
| USART3 | ESP-01s WiFi | 115200 | PB10 | PB11 | WiFi网络通信 |

#### 2.2.2 ADC传感器采集
| 通道 | 引脚 | 传感器 | 功能 |
|------|------|--------|------|
| IN1 | PA1 | 热敏电阻 | 温度检测 |
| IN4 | PA4 | 光敏电阻 | 光线强度检测 |
| IN9 | PB1 | MQ135 | 气体浓度检测 |

#### 2.2.3 GPIO控制
| 引脚 | 功能 | 用途 |
|------|------|------|
| PA0 | LED1 | 系统状态指示 |
| PB8 | LED2 | 网络状态指示 |
| PB7 | 蜂鸣器 | 报警提示 |
| PA11 | 按键 | 系统重启 |

#### 2.2.4 SPI Flash
| 引脚 | 功能 |
|------|------|
| PA5 | SPI1_SCK |
| PA6 | SPI1_MISO |
| PA7 | SPI1_MOSI |
| PB5 | W25Q64_CS |

#### 2.2.5 定时器资源
| 定时器 | 功能 | 用途 |
|--------|------|------|
| TIM2 | 精确延时 | 微秒/毫秒级延时函数 |
| TIM4 | 空闲检测 | 串口空闲检测 |
| IWDG | 看门狗 | 系统健康监控 |

## 3. 软件架构设计

### 3.1 层次结构

```
┌─────────────────────────────────────────┐
│         应用层 (Application)            │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐    │
│  │ 任务1   │ │ 任务2   │ │ 任务3   │    │
│  │网络管理 │ │数据采集 │ │数据发送 │    │
│  └─────────┘ └─────────┘ └─────────┘    │
│  ┌─────────┐                            │
│  │ 任务4   │                            │
│  │系统监控 │                            │
│  └─────────┘                            │
├─────────────────────────────────────────┤
│      中间件层 (Middleware)              │
│ ┌─────────┐ ┌─────────┐ ┌─────────┐     │
│ │FreeRTOS │ │环形缓冲 │ │状态机   │     │
│ │         │ │器管理   │ │驱动     │     │
│ └─────────┘ └─────────┘ └─────────┘     │
├─────────────────────────────────────────┤
│       驱动层 (Driver Layer)             │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐        │
│ │USART│ │ ADC │ │ GPIO│ │SPI  │        │
│ └─────┘ └─────┘ └─────┘ └─────┘        │
│ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐        │
│ │Flash│ │IWDG │ │TIM2 │ │TIM4 │        │
│ └─────┘ └─────┘ └─────┘ └─────┘        │
├─────────────────────────────────────────┤
│      库层 (Library Layer)              │
│    ┌──────────────────────────────┐    │
│    │   STM32标准外设库(StdLib)    │    │
│    │   startup_stm32f1xx.s        │    │
│    │   system_stm32f1xx.c         │    │
│    └──────────────────────────────┘    │
├─────────────────────────────────────────┤
│        硬件层 (Hardware Layer)          │
│    ┌──────────────────────────────┐    │
│    │        STM32F103C8T6         │    │
│    └──────────────────────────────┘    │
└─────────────────────────────────────────┘
```

### 3.2 模块化设计

#### 3.2.1 主要模块
1. **main.c/h** - 主程序入口和系统配置
2. **usart.c/h** - 串口通信和AT指令状态机
3. **adc.c/h** - ADC传感器数据采集
4. **flash.c/h** - 内部Flash管理（WiFi配置）
5. **spi_flash.c/h** - SPI Flash管理（传感器数据）
6. **gpio.c/h** - GPIO控制和外部中断
7. **tasks.c/h** - FreeRTOS 4任务实现
8. **delay.c/h** - TIM2精确延时函数

#### 3.2.2 关键数据结构

**传感器数据结构**（无时间戳）:
```c
typedef struct {
    float temperature;      // 温度值 (摄氏度)
    uint16_t light_level;  // 光线强度 (0-4095)
    uint16_t gas_level;    // 气体浓度 (ppm)
} Sensor_Data_t;
```

**AT指令结构**:
```c
typedef struct {
    char cmd[32];          // AT指令字符串
    char response[64];     // 期望响应
    uint32_t timeout;      // 超时时间(毫秒)
    uint8_t max_retry;     // 最大重试次数
} AT_Command_t;
```

**SPI Flash元数据结构**:
```c
typedef struct {
    uint32_t write_pointer;     // 写指针
    uint32_t read_pointer;      // 读指针
    uint32_t data_start_addr;   // 数据起始地址
    uint32_t data_end_addr;     // 数据结束地址
    uint32_t record_count;      // 记录总数
} SPI_Flash_Meta_t;
```

### 3.3 数据流设计

```
传感器数据流程:
传感器 → ADC采样 → 数据处理 → 环形缓冲区 → 等待发送
                                         ↓
网络状态 ← WiFi模块 ← AT指令 ← 串口通信 ← 发送队列
```

```
配置数据流程:
用户配置 → 内部Flash存储 → 系统启动读取 → 运行时应用
```

## 4. FreeRTOS任务架构

### 4.1 4任务设计

#### 4.1.1 任务优先级
- **Task1 - 网络管理任务** (优先级3, 最高)
  - 功能: 维护WiFi连接，处理AT指令状态机
  - 状态: 长期运行
  - 周期: 事件驱动，连接检测间隔5秒

#### 4.1.2 任务功能
- **Task2 - 数据采集任务** (优先级2)
  - 功能: 周期性采集传感器数据
  - 周期: 5秒采集一次
  - 输出: 写入SPI Flash环形缓冲区

- **Task3 - 数据发送任务** (优先级2)
  - 功能: 从环形缓冲区读取数据并发送
  - 周期: 检查间隔10秒
  - 输出: 通过WiFi发送到服务器

- **Task4 - 系统监控任务** (优先级1, 最低)
  - 功能: 系统健康检查，LED状态，看门狗喂狗
  - 周期: 1秒一次
  - 状态: 系统运行时间和错误统计

### 4.2 任务间通信
- **队列(Queue)**: 网络消息传递
- **互斥锁(Mutex)**: 串口资源保护
- **信号量(Semaphore)**: 同步事件触发

## 5. 数据存储方案

### 5.1 内部Flash存储
- **用途**: WiFi配置参数存储
- **地址**: 0x08007C00 - 0x08007FFF (1KB)
- **内容**: SSID, 密码, 服务器IP, 端口
- **特点**: 掉电不丢失，页擦除(2KB)

### 5.2 SPI Flash存储
- **型号**: W25Q64 (8MB)
- **用途**: 传感器数据环形缓冲区
- **数据区**: 0x100000 - 0x7FFFFFF (7MB)
- **格式**: "TEMP:25.6 LIGHT:456 GAS:789\r\n"
- **容量**: 约20万条记录
- **管理**: 读指针、写指针分离

### 5.3 数据格式
**发送格式**: 简单文本，无时间戳
```
TEMP:25.6 LIGHT:456 GAS:789\r\n
```

**存储格式**: 二进制结构
```
[传感器数据] = [温度4字节] + [光线2字节] + [气体2字节] = 8字节
```

## 6. 状态机设计

### 6.1 AT指令状态机
```
IDLE → SENDING → WAITING → RECEIVING
   ↑                        ↓
   └──────── ERROR ←───────┘
```

**状态说明**:
- IDLE: 空闲状态，等待指令
- SENDING: 发送AT指令
- WAITING: 等待响应
- RECEIVING: 接收并解析响应
- SUCCESS: 指令执行成功
- ERROR: 指令执行失败

### 6.2 网络连接状态机
```
DISCONNECTED → CONNECTING → CONNECTED
    ↑              ↓            │
    │              └─────────→ SEND_DATA
    │                         ↓
    └─────── ERROR ←──────────┘
```

## 7. 技术特点

### 7.1 关键优势
- **实时性**: FreeRTOS多任务并发
- **可靠性**: 环形缓冲区防数据丢失
- **可维护性**: 模块化设计，代码清晰
- **扩展性**: 易于添加新传感器或功能

### 7.2 性能指标
- **数据采集**: 5秒周期，12位ADC精度
- **数据存储**: 7MB容量，约20万条记录
- **网络连接**: 115200bps WiFi通信
- **系统稳定**: 看门狗保护，异常恢复

### 7.3 错误处理
- **网络异常**: 自动重连机制
- **Flash错误**: 写保护，坏块跳过
- **任务异常**: 看门狗监控，系统重启
- **内存不足**: 环形缓冲区溢出保护

## 8. 开发注意事项

### 8.1 禁止使用
- ❌ HAL库任何函数
- ❌ 任何时间戳相关代码
- ❌ HTTP数据格式
- ❌ 数据统计分析

### 8.2 必须使用
- ✅ STM32标准外设库
- ✅ "传感器名:数据\r\n"格式
- ✅ 详细注释和知识点
- ✅ 头文件和源文件分离

### 8.3 重要提醒
- 所有外设配置使用标准库
- 延时函数使用TIM2实现
- 串口通信使用中断方式
- Flash操作注意擦除时序
- 看门狗设置合适超时时间

## 9. 文件结构

```
stm32_environment_monitor_v2/
├── main.c/h                    // 主程序和配置
├── usart.c/h                   // 串口通信
├── adc.c/h                     // ADC采集
├── flash.c/h                   // 内部Flash
├── spi_flash.c/h               // SPI Flash
├── gpio.c/h                    // GPIO控制
├── tasks.c/h                   // FreeRTOS任务
├── delay.c/h                   // 延时函数
├── system_stm32f1xx.c          // 系统时钟配置
├── startup_stm32f1xx.s         // 启动文件
├── stm32f1xx.h                 // 标准库头文件
├── SYSTEM_ARCHITECTURE.md      // 本文档
└── DEEP_TECHNICAL_ANALYSIS.md  // 深度技术分析
```

## 10. 总结

本架构设计严格遵循用户要求：
1. **完全使用STM32标准外设库**，避免HAL库
2. **彻底去除时间戳功能**，数据结构简洁
3. **简单数据格式**，无HTTP封装
4. **模块化设计**，头文件源文件清晰分离
5. **详细注释**，包含技术知识点补充

系统设计确保稳定性、可靠性和可维护性，为环境监测应用提供完整的解决方案。
